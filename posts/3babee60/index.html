<!DOCTYPE html><html class="theme-next gemini use-motion" lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/my-favicon-16x16.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="ssd,"><link rel="alternate" href="/atom.xml" title="rovo98's Blog" type="application/atom+xml"><meta name="description" content="就在最近，终于为自己的电脑加装了固态。在装完固态之后，首先面临的问题就是如何将原先安装在机械硬盘上的linux系统迁移到固态上。还要考虑后续配置的问题。 本文主要讲述在迁移Linux系统到新的固态硬盘上所遇到的问题以及找到的相应的解决方法。 这里先给出系统迁移以及相关配置完成之后的机械硬盘和固态硬盘的简单测速对比:"><meta name="keywords" content="ssd"><meta property="og:type" content="article"><meta property="og:title" content="记录一次linux系统迁移过程"><meta property="og:url" content="http://rovo98.github.io/posts/3babee60/index.html"><meta property="og:site_name" content="rovo98&#39;s Blog"><meta property="og:description" content="就在最近，终于为自己的电脑加装了固态。在装完固态之后，首先面临的问题就是如何将原先安装在机械硬盘上的linux系统迁移到固态上。还要考虑后续配置的问题。 本文主要讲述在迁移Linux系统到新的固态硬盘上所遇到的问题以及找到的相应的解决方法。 这里先给出系统迁移以及相关配置完成之后的机械硬盘和固态硬盘的简单测速对比:"><meta property="og:locale" content="en"><meta property="og:image" content="http://rovo98.github.io/images/linux/hdparam.png"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/install_ssd01.jpg"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/install_ssd02.jpg"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/fdisk_parted.png"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/mount-bind.png"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/efi_root.png"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/blkid.png"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/byuuid.png"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/updated-fstab.png"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/refind.png"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/efibootmgr.png"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/trim-supported.png"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/lsblk-discard.png"><meta property="og:image" content="http://rovo98.github.io/posts/3babee60/io-schedulers.png"><meta property="og:updated_time" content="2018-11-14T15:21:00.995Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="记录一次linux系统迁移过程"><meta name="twitter:description" content="就在最近，终于为自己的电脑加装了固态。在装完固态之后，首先面临的问题就是如何将原先安装在机械硬盘上的linux系统迁移到固态上。还要考虑后续配置的问题。 本文主要讲述在迁移Linux系统到新的固态硬盘上所遇到的问题以及找到的相应的解决方法。 这里先给出系统迁移以及相关配置完成之后的机械硬盘和固态硬盘的简单测速对比:"><meta name="twitter:image" content="http://rovo98.github.io/images/linux/hdparam.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!0,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><script></script><title>记录一次linux系统迁移过程 | rovo98's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">rovo98's Blog</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Leave your comfort zone!</p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> Home</a></li><li class="menu-item menu-item-top"><a href="/top/" rel="section"><i class="menu-item-icon fa fa-fw fa-signal"></i><br> Posts Ranking</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> Archives</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> Search</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://rovo98.github.io/posts/3babee60/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="rovo98"><meta itemprop="description" content=""><meta itemprop="image" content="/images/personal-logo.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="rovo98's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">记录一次linux系统迁移过程</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-07T14:00:00+08:00">2018-10-07</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span></span> <span id="/posts/3babee60/" class="leancloud_visitors" data-flag-title="记录一次linux系统迁移过程"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">Visitors&#58;</span><span class="leancloud-visitors-count"></span></span> <span class="post-meta-divider">|</span><span class="page-pv"><i class="fa fa-file-o"></i><span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">Words count in article&#58;</span> <span title="Words count in article">3,191</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">Reading time &asymp;</span> <span title="Reading time">15</span></div></div></header><div class="post-body" itemprop="articleBody"><p>就在最近，终于为自己的电脑加装了固态。在装完固态之后，首先面临的问题就是如何将原先安装在机械硬盘上的<code>linux</code>系统迁移到固态上。还要考虑后续配置的问题。</p><p>本文主要讲述在迁移<code>Linux</code>系统到新的固态硬盘上所遇到的问题以及找到的相应的解决方法。</p><p>这里先给出系统迁移以及相关配置完成之后的机械硬盘和固态硬盘的简单测速对比:</p><p><img src="/images/linux/hdparam.png" alt=""></p><a id="more"></a><h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><div class="note info"><p>拆开电脑，直接加装固态,顺便清清灰尘，换一下硅脂(ps: 这不知道是我第几次拆电脑了…,表示以后再也不买GPU风扇了，这已经是第二次失败的购买经历了(<code>除非得到与原来匹配的风扇一致的风扇，不然我是不再换了</code>).</p></div><p>清尘换硅脂:</p><p><img src="install_ssd01.jpg" alt="install-ssd-01"><br>加装固态和散热板:</p><p><img src="install_ssd02.jpg" alt="install-ssd-01"></p><div class="note primary"><p>关于固态如何购买挑选，需要很好的了解自己电脑能够支持的固态类型和市场所提供的固态类型，并综合各种因素才能做出最好的选择。这里我推荐几篇个人觉得不错的文章:</p><ul><li><a href="https://www.laptopmag.com/articles/laptop-ssd-guide" target="_blank" rel="noopener">https://www.laptopmag.com/articles/laptop-ssd-guide</a></li><li><a href="https://www.tomshardware.com/reviews/ssd-buying-guide,5602.html" target="_blank" rel="noopener">https://www.tomshardware.com/reviews/ssd-buying-guide,5602.html</a></li><li><a href="https://www.velocitymicro.com/blog/nvme-vs-m-2-vs-sata-whats-the-difference/" target="_blank" rel="noopener">https://www.velocitymicro.com/blog/nvme-vs-m-2-vs-sata-whats-the-difference/</a></li><li><a href="https://blog.csdn.net/u010109732/article/details/79032845" target="_blank" rel="noopener">https://blog.csdn.net/u010109732/article/details/79032845</a></li><li><a href="https://www.zhihu.com/question/48972075" target="_blank" rel="noopener">https://www.zhihu.com/question/48972075</a></li><li><a href="https://www.pc841.com/article/20180914-92342_all.html" target="_blank" rel="noopener">https://www.pc841.com/article/20180914-92342_all.html</a></li><li><a href="https://www.techadvisor.co.uk/test-centre/storage/best-ssd-2018-3235200/" target="_blank" rel="noopener">https://www.techadvisor.co.uk/test-centre/storage/best-ssd-2018-3235200/</a></li></ul><p>以上推荐文章仅作为参考。</p></div><h3 id="迁移系统"><a href="#迁移系统" class="headerlink" title="迁移系统"></a>迁移系统</h3><h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p>进入原先的<code>linux</code>系统，对已经安装上的固态硬盘进行分区。因为我之前在没有固态之前，在机械硬盘上就已经安装了三个系统(<code>win10</code>, <code>manjaro</code>, <code>kali</code>),因此在分区时，我是考虑只把两个<code>linux</code>迁移到固态上，毕竟<code>win10</code>现在已经基本不使用了，并将机械硬盘上的<code>EFI</code>分区也迁移到固态上。分区这里，可以按照自己的需求对固态硬盘进行分区。</p><p>分区工具的选择，随意，哪个顺手用哪个，例如:<code>gparted</code>, <code>fdisk</code>, <code>parted</code>,还有各种桌面自带的分区工具。我是使用的是<code>fdisk</code>:<br>例如:<br></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fdisk /dev/nvme0n1</span><br></pre></td></tr></table></figure></div><p></p><p><img src="fdisk_parted.png" alt="diskparted"></p><p>这里我已经分好区了的，具体的操作在<code>fdisk</code>中进行:</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Generic</span><br><span class="line">   d   delete a partition</span><br><span class="line">   F   list free unpartitioned space</span><br><span class="line">   l   list known partition types</span><br><span class="line">   n   add a new partition</span><br><span class="line">   p   print the partition table</span><br><span class="line">   t   change a partition type</span><br><span class="line">   v   verify the partition table</span><br><span class="line">   i   print information about a partition</span><br><span class="line"></span><br><span class="line">  Misc</span><br><span class="line">   m   print this menu</span><br><span class="line">   x   extra functionality (experts only)</span><br><span class="line"></span><br><span class="line">  Script</span><br><span class="line">   I   load disk layout from sfdisk script file</span><br><span class="line">   O   dump disk layout to sfdisk script file</span><br><span class="line"></span><br><span class="line">  Save &amp; Exit</span><br><span class="line">   w   write table to disk and exit</span><br><span class="line">   q   quit without saving changes</span><br><span class="line"></span><br><span class="line">  Create a new label</span><br><span class="line">   g   create a new empty GPT partition table</span><br><span class="line">   G   create a new empty SGI (IRIX) partition table</span><br><span class="line">   o   create a new empty DOS partition table</span><br><span class="line">   s   create a new empty Sun partition table</span><br></pre></td></tr></table></figure></div><p>例如创建<code>EFI</code>分区:</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Command (m for help): n</span><br><span class="line">Partition number (2-128, default 2): 2 # 创建一个分区作为EFI分区</span><br><span class="line">First sector (xxxxx-xxxxxxxxxxx, default xxxxx): </span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G,T,P&#125; (34-2047, default xxxxxxx): +200M</span><br><span class="line">Created a new partition 2 of type &apos;Linux filesystem&apos; and of size 200 Mb.</span><br><span class="line">Command (m for help): t  # 修改EFI分区的分区类型为EFI系统分区</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># 最后保存设置</span><br><span class="line">Command (m for help): w</span><br></pre></td></tr></table></figure></div><div class="note danger"><p>请注意先查看所执行的分区操作是不是你想要的再进行最后的保存设置</p></div><p>其他的分区创建类似<code>EFI</code>的创建，<code>swap</code>分区需要指定为<code>Linux swap</code>分区，作为<code>linux</code>数据分区的分区在创建时默认就是<code>linux filesystem</code>类型了，不需要更改，之后对创建的分区进行格式化:将<code>EFI</code>格式化为<code>fat32</code>，将<code>linux</code>数据分区格式化<code>ext4</code>； 先通过<code>sudo fdisk -l</code>或<code>lsblk</code>查看已经创建分区对应的设备名,例如:<br><code>sudo fdisk -l</code>:</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Disk /dev/nvme0n1: 238.5 GiB, 256060514304 bytes, 500118192 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel type: gpt</span><br><span class="line">Disk identifier: 6D071E80-FF82-420B-A2D8-7A0BC4759F06</span><br><span class="line"></span><br><span class="line">Device             Start       End   Sectors  Size Type</span><br><span class="line">/dev/nvme0n1p1        34    262177    262144  128M Microsoft reserved</span><br><span class="line">/dev/nvme0n1p2    264192    673791    409600  200M EFI System</span><br><span class="line">/dev/nvme0n1p3    673792   9062399   8388608    4G Linux swap</span><br><span class="line">/dev/nvme0n1p4   9062400 428492799 419430400  200G Linux filesystem</span><br><span class="line">/dev/nvme0n1p5 428492800 500117503  71624704 34.2G Linux filesystem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 931.5 GiB, 1000204886016 bytes, 1953525168 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 4096 bytes</span><br><span class="line">I/O size (minimum/optimal): 4096 bytes / 4096 bytes</span><br><span class="line">Disklabel type: gpt</span><br><span class="line">Disk identifier: D5CB68A7-96DA-4C61-84E2-61C98489BFF1</span><br><span class="line"></span><br><span class="line">Device          Start        End   Sectors   Size Type</span><br><span class="line">/dev/sda1          64  125829183 125829120    60G Microsoft basic data</span><br><span class="line">/dev/sda2   125829184  880802416 754973233   360G Microsoft basic data</span><br><span class="line">/dev/sda3   880803904 1596575151 715771248 341.3G Microsoft basic data</span><br><span class="line">/dev/sda4  1596575744 1953521663 356945920 170.2G Microsoft basic data</span><br></pre></td></tr></table></figure></div><p><code>lsblk</code> 查看分好的磁盘分区:</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda           8:0    0 931.5G  0 disk </span><br><span class="line">├─sda1        8:1    0    60G  0 part /run/media/rovo98/System</span><br><span class="line">├─sda2        8:2    0   360G  0 part /run/media/rovo98/Mshinoda</span><br><span class="line">├─sda3        8:3    0 341.3G  0 part /run/media/rovo98/Chester bennington</span><br><span class="line">└─sda4        8:4    0 170.2G  0 part /run/media/rovo98/LSR</span><br><span class="line">sr0          11:0    1  1024M  0 rom  </span><br><span class="line">nvme0n1     259:0    0 238.5G  0 disk </span><br><span class="line">├─nvme0n1p1 259:1    0   128M  0 part </span><br><span class="line">├─nvme0n1p2 259:2    0   200M  0 part /boot/efi</span><br><span class="line">├─nvme0n1p3 259:3    0     4G  0 part [SWAP]</span><br><span class="line">├─nvme0n1p4 259:4    0   200G  0 part /</span><br><span class="line">└─nvme0n1p5 259:5    0  34.2G  0 part /run/media/rovo98/a002d542-c8c4-4c98-85af-8a4446dbaa1b</span><br></pre></td></tr></table></figure></div><p>对特定的分区进行格式化,例如:</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 对于linux数据分区</span><br><span class="line">mkfs.ext4 /dev/nvme0n1p4</span><br><span class="line">mkfs.ext4 /dev/nvme0n1p5</span><br><span class="line"># EFI分区</span><br><span class="line">mkfs.fat /dev/nvme0n1p2</span><br></pre></td></tr></table></figure></div><div class="note danger"><p><strong>注意</strong>: 执行每条格式化命令前，必须确认指定的分区是否是你想要格式化的分区</p></div><p>做好这些准备之后，就可以进行系统的迁移了</p><h4 id="系统迁移操作"><a href="#系统迁移操作" class="headerlink" title="系统迁移操作"></a>系统迁移操作</h4><p>对于<code>Linux</code>系统，我们只需要知道<strong>Linux一切皆文件</strong>就行了。因此对于系统的迁移就变得简单了，可以使用<code>dd</code>,打包压缩然后解压缩，有关系统备份和恢复可以参看<code>Arch wiki</code>给出的:<a href="https://wiki.archlinux.org/index.php/System_backup" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/System_backup</a>.这里我是使用的是<code>tar</code>结合<code>pigz</code>(<a href="http://www.ywnds.com/?p=10332" target="_blank" rel="noopener">什么是pigz?</a>)解压缩工具进行备份和恢复:</p><p>备份(打包压缩)<br></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar --use-compress-program=pigz -cvpf /run/media/rovo98/Chester\ bennington/LP/GHOST/manjaro_backup_2018.10.7.tgz --exclude=/proc --exclude=/sys --exclude=/mnt --exclude=/run/media --exclude=/lost+found /</span><br></pre></td></tr></table></figure></div><p></p><p>恢复到目标硬盘分区上(解包解压缩):<br>先目标分区挂载到<code>/mnt</code>下，如:<code>/mnt/manjaro</code></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/nvme0n1p4 /mnt/manjaro</span><br></pre></td></tr></table></figure></div><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar --use-compress-program=pigz -xvpf /run/media/rovo98/Chester\ bennington/LP/GHOST/manjaro_backup_2018.10.7.tgz -C /mnt/manjaro</span><br></pre></td></tr></table></figure></div><p>完成后需要手动创建，上面打包压缩是排除的文件夹:<code>/proc</code>, <code>/sys</code>, <code>/mnt</code>, <code>/run</code>, <code>/lost+found</code>.</p><div class="note primary"><p>详细备份和恢复过程可以参考查看:<a href="https://www.jianshu.com/p/b03a51c682a5" target="_blank" rel="noopener">Arch上的备份还原</a></p></div><h4 id="修复Grub、fstab文件以及refind引导管理"><a href="#修复Grub、fstab文件以及refind引导管理" class="headerlink" title="修复Grub、fstab文件以及refind引导管理"></a>修复Grub、fstab文件以及refind引导管理</h4><p>首先将<code>/proc</code>,<code>/run</code>,<code>/dev</code>,<code>/sys</code>重新挂载，让目标分区上的系统也拥有这些内容:</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mount /proc /mnt/manjaro/proc</span><br><span class="line">mount /sys /mnt/manjaro/sys</span><br><span class="line">mount /run /mnt/manjaro/run</span><br><span class="line">mount /dev /mnt/manjaro/dev</span><br></pre></td></tr></table></figure></div><div class="note warning"><p>这些目录必须重新挂载，不然，当<code>chroot</code>切换进入目标系统之后，将无法获取一些系统信息，如：设备, 磁盘分区信息等.</p></div><p><img src="mount-bind.png" alt=""></p><p>在<code>chroot</code>到目标系统之前，需要挂载<code>EFI</code>分区到<code>/mnt/manjaro/boot/efi</code>（refind管理文件默认位置）下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/nvme0n1p2 /mnt/manjaro/boot/efi</span><br></pre></td></tr></table></figure></div><p><img src="efi_root.png" alt=""></p><p><code>chroot</code>到目标系统中，进行之后的操作</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chroot /mnt/manjaro</span><br></pre></td></tr></table></figure></div><h4 id="更新fstab文件"><a href="#更新fstab文件" class="headerlink" title="更新fstab文件"></a>更新fstab文件</h4><p>获取相应分区的<code>UUID</code>，以更新<code>fstab</code>文件和<code>/etc/default/grub</code>文件:<br><code>blkid</code>:</p><p><img src="blkid.png" alt=""></p><p>或</p><p><code>ls -l /dev/disk/by-uuid</code>:</p><p><img src="byuuid.png" alt=""></p><p>更新<code>fstab</code>文件:</p><p><img src="updated-fstab.png" alt=""></p><div class="note primary"><p>主要修改挂载项以及对应的<code>UUID</code>，有关<code>fstab</code>文件的详细内容可以参考<a href="https://wiki.archlinux.org/index.php/Fstab" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/Fstab</a></p></div><h4 id="修复Grub"><a href="#修复Grub" class="headerlink" title="修复Grub"></a>修复Grub</h4><ol><li><p>重新生成Grub</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader=Manjaro --recheck</span><br></pre></td></tr></table></figure></div></li><li><p>更新Grub配置文件</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo update-grub</span><br><span class="line">或</span><br><span class="line">sudo grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure></div></li></ol><div class="note warning"><p><strong>注意</strong>：如果此过程中出现以下提示信息:</p><p><code>EFI variables are not supported on this system.</code></p><p>需要先安装<code>efibootmgr</code>, <code>dosfstools</code>以及<code>grub</code>包，然后重新尝试重新生成<code>Grub</code>并更新其配置文件.</p></div><p>若仍出现该信息，则先退出<code>chroot</code>环境，并加载<code>efivarfs</code>模块:</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo modprobe efivarfs</span><br></pre></td></tr></table></figure></div><p>然后再进入<code>chroot</code>环境，执行:</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t efivarfs efivarfs /sys/firmware/efi/efivars</span><br></pre></td></tr></table></figure></div><p>再重新生成<code>Grub</code>并更新<code>Grub</code>配置文件就好了。</p><div class="note primary"><p>参考链接:<a href="https://wiki.manjaro.org/index.php/Restore_the_GRUB_Bootloader" target="_blank" rel="noopener">https://wiki.manjaro.org/index.php/Restore_the_GRUB_Bootloader</a></p></div><h4 id="重新配置refind"><a href="#重新配置refind" class="headerlink" title="重新配置refind"></a>重新配置refind</h4><p>对之前的<code>refind</code>配置文件进行备份，保留主题文件<code>themes</code>及<code>refind.conf</code>就好了，其余的文件在执行<code>refind-install</code>时会自动生成.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 已经生成过了的,打印信息如下</span><br><span class="line">ShimSource is none</span><br><span class="line">Installing rEFInd on Linux....</span><br><span class="line">ESP was found at /boot/efi using vfat</span><br><span class="line">Found rEFInd installation in /boot/efi/EFI/refind; upgrading it.</span><br><span class="line">Installing driver for ext4 (ext4_x64.efi)</span><br><span class="line">Copied rEFInd binary files</span><br><span class="line"></span><br><span class="line">Notice: Backed up existing icons directory as icons-backup.</span><br><span class="line">Existing refind.conf file found; copying sample file as refind.conf-sample</span><br><span class="line">to avoid overwriting your customizations.</span><br><span class="line"></span><br><span class="line">Keeping existing NVRAM entry</span><br><span class="line">rEFInd is set as the default boot manager.</span><br><span class="line">Existing //boot/refind_linux.conf found; not overwriting.</span><br></pre></td></tr></table></figure></div><p><img src="refind.png" alt=""></p><p>可以使用<code>efibootmgr</code>管理启动项，例如:<br><code>efibootmgr</code>查看当前所有的启动项，<code>efibootmgr -Bb xxxx</code>来删除不要的启动项，详细使用可以<code>man efibootmgr</code>来查看。</p><p><img src="efibootmgr.png" alt=""></p><p>其中的<code>windows</code>系统启动项通过<code>PE</code>用<code>UEFI</code>引导修复生成即可(需要注意的是老旧的PE识别不了<code>nvme</code>固态)。</p><p>以上就是迁移Linux系统的完整过程了</p><h4 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h4><p>在做完上面的所有操作，并将之前机械硬盘上的<code>EFI</code>分区等等(除<code>Win10</code>系统之外)都删除之后，重新启动进入固态盘上的系统，在<code>Grub</code>引导过程出现<code>UUID=***************</code>找不到的信息，经过查看之后发现，在<code>Grub</code>引导时居然没有挂载我那块<code>nvme</code>固态。</p><p>通过了解发现<code>Grub2.2</code>版本并不支持<code>nvme</code>的固态，可以使用安装<code>bootloader</code>来进行引导。PS: 但我<code>Manjaro</code>安装的<code>Grub</code>是<code>2.3</code>版本的，理论上是支持的。</p><div class="note primary"><p>参考链接: <a href="https://bbs.archlinux.org/viewtopic.php?id=209653" target="_blank" rel="noopener">https://bbs.archlinux.org/viewtopic.php?id=209653</a></p></div><p>通过一番查找之后，终于找到了解决方法:</p><ol><li><p>添加加载模块 <code>sudo vim /etc/mkinitcpio.conf</code></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="DIFF"><figure class="iseeu highlight /diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="deletion">- MODULES = ""</span></span><br><span class="line"><span class="addition">+ MODULES="nvme"</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure></div></li><li><p>更新<code>mkinitcpio</code></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#参数说明，详细可以通过man查看</span><br><span class="line">-p, --preset preset</span><br><span class="line">Build initramfs image(s) according to specified preset. This may be a file in /etc/mkinitcpio.d (without the .preset extension) or a full, absolute path to a file. This option may be specified multiple times to process multiple presets.</span><br></pre></td></tr></table></figure></div></li><li><p>更新Grub</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo update-grub</span><br><span class="line">或</span><br><span class="line">sudo grub-mkocnfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure></div></li></ol><p>再次重启之后，便可以成功进入系统了。</p><div class="note primary"><p>参考链接:<a href="http://blog.51cto.com/shenfly231/1918426" target="_blank" rel="noopener">http://blog.51cto.com/shenfly231/1918426</a>, 若要安装<code>bootloader</code>也可以参考该链接。</p></div><h3 id="SSD优化"><a href="#SSD优化" class="headerlink" title="SSD优化"></a>SSD优化</h3><h4 id="开启Trim功能"><a href="#开启Trim功能" class="headerlink" title="开启Trim功能"></a>开启Trim功能</h4><p>关于什么是<code>TRIM</code>?：</p><blockquote><p>SSD TRIM is an Advanced Technology Attachment (ATA) command that enables an operating system to inform a NAND flash solid-state drive (SSD) which data blocks it can erase because they are no longer in use. The use of TRIM can improve the performance of writing data to SSDs and contribute to longer SSD life.</p></blockquote><div class="note primary"><p>了解可以参考: <a href="https://searchstorage.techtarget.com/definition/TRIM" target="_blank" rel="noopener">https://searchstorage.techtarget.com/definition/TRIM</a>，以及<code>Arch wiki</code>上的:<br><a href="https://wiki.archlinux.org/index.php/Solid_state_drive#TRIM" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/Solid_state_drive#TRIM</a></p></div><blockquote><p>Most SSDs support the <strong>ATA_TRIM command</strong> for <strong>sustained long-term performance and wear-leveling</strong>. A techspot article shows performance benchmark examples of before and after filling an SSD with data.</p><p>As of Linux kernel version 3.8 onwards, support for TRIM was continually added for the different filesystems. See the following table for an indicative overview:</p></blockquote><p><img src="trim-supported.png" alt=""></p><p>在使用<code>Trim</code>功能之前需要查看固态硬盘是否支持，否则可能造成数据丢失:</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsblk --discard</span><br></pre></td></tr></table></figure></div><p><img src="lsblk-discard.png" alt=""></p><p><code>DISC-GRAN</code>和<code>DISC-MAX</code>不为<code>0</code>则表示支持，详细查看上面的<code>Arch Wiki</code>给出的文章。</p><p>关于使用的<code>Trim</code>方式，我使用的<code>Continuous TRIM</code>(详见<code>Arch Wiki</code>)<br>即在<code>/etc/fstab</code>文件的挂载项中添加参数<code>discard</code><br></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="DIFF"><figure class="iseeu highlight /diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- UUID=D942-EEB0                            /boot/efi      vfat    defaults,noatime 0 2</span></span><br><span class="line"><span class="deletion">- UUID=67180790-92d0-48d3-8f00-448161019f2d swap           swap    defaults,noatime 0 2</span></span><br><span class="line"><span class="deletion">- UUID=e2708091-5a07-47a6-bc26-5fdaa044c5f3 /              ext4    defaults,noatime 0 1</span></span><br><span class="line"><span class="addition">+ UUID=D942-EEB0                            /boot/efi      vfat    defaults,discard,noatime 0 2</span></span><br><span class="line"><span class="addition">+ UUID=67180790-92d0-48d3-8f00-448161019f2d swap           swap    defaults,discard,noatime 0 2</span></span><br><span class="line"><span class="addition">+ UUID=e2708091-5a07-47a6-bc26-5fdaa044c5f3 /              ext4    defaults,discard,noatime 0 1</span></span><br></pre></td></tr></table></figure></div><p></p><h4 id="IO调度器选择"><a href="#IO调度器选择" class="headerlink" title="IO调度器选择"></a>IO调度器选择</h4><p>一般来说，IO调度算法是为低速硬盘准备的，对于固态，最好是不使用任何IO调度器，或使用对硬盘干预程度最低的调度算法。</p><ol><li>查看当前固态的IO调度器:<br><img src="io-schedulers.png" alt=""><br>可以看到我当前固态没有使用任何调度器，而机械硬盘使用的是<code>bfq-sq</code>.</li><li><p>修改IO调度器(临时的):</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo noop &gt; /sys/block/sda/queue/scheduler</span><br></pre></td></tr></table></figure></div></li><li><p>要永久生效则需要添加编写开机自启动脚本<br>详见参考链接.</p></li></ol><div class="note primary"><p>更多信息以及详细的内容可以参考下面给出的参考链接.<br>参考链接:</p><ul><li><a href="https://wiki.archlinux.org/index.php/Improving_performance#Storage_devices" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/Improving_performance#Storage_devices</a></li><li><a href="https://blog.codeship.com/linux-io-scheduler-tuning/" target="_blank" rel="noopener">https://blog.codeship.com/linux-io-scheduler-tuning/</a></li><li><a href="https://www.ibm.com/developerworks/cn/linux/l-lo-io-scheduler-optimize-performance/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/linux/l-lo-io-scheduler-optimize-performance/index.html</a></li></ul></div><h4 id="另外"><a href="#另外" class="headerlink" title="另外"></a>另外</h4><div class="note primary"><p>更多有关<code>Linux VM</code>性能调优的可以参考:<br><a href="https://lonesysadmin.net/tag/linux-vm-performance-tuning/" target="_blank" rel="noopener">https://lonesysadmin.net/tag/linux-vm-performance-tuning/</a></p></div></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------The End<i class="fa fa-coffee"></i> Thanks for reading.-------------</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>Donate me, thanks for your support!</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>Donate</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="/images/wechat_code.jpg" alt="rovo98 WeChat Pay"><p>WeChat Pay</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="/images/alipay_code.jpg" alt="rovo98 Alipay"><p>Alipay</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>Post author:</strong> rovo98</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="http://rovo98.github.io/posts/3babee60/" title="记录一次linux系统迁移过程">http://rovo98.github.io/posts/3babee60/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/ssd/" rel="tag"><i class="fa fa-tag"></i> ssd</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/97c4fd12/" rel="next" title="编译自己的Vim8.1"><i class="fa fa-chevron-left"></i> 编译自己的Vim8.1</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/posts/7ea77913/" rel="prev" title="GPG入门使用">GPG入门使用<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><script>window._bd_share_config={common:{bdText:"",bdMini:"1",bdMiniList:!1,bdPic:""},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"},slide:{bdImg:"5",bdPos:"left",bdTop:"100"}}</script><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div><div id="gitalk-container"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/personal-logo.jpg" alt="rovo98"><p class="site-author-name" itemprop="name">rovo98</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">25</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">13</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">20</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/rovo98" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Friend Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://dcLunatic.github.io" title="dcLunatic" target="_blank">dcLunatic</a></li><li class="links-of-blogroll-item"> <a href="https://adj325.github.io" title="Adj325" target="_blank">Adj325</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#引入"><span class="nav-number">1.</span> <span class="nav-text">引入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#迁移系统"><span class="nav-number">2.</span> <span class="nav-text">迁移系统</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#准备"><span class="nav-number">2.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#系统迁移操作"><span class="nav-number">2.2.</span> <span class="nav-text">系统迁移操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修复Grub、fstab文件以及refind引导管理"><span class="nav-number">2.3.</span> <span class="nav-text">修复Grub、fstab文件以及refind引导管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#更新fstab文件"><span class="nav-number">2.4.</span> <span class="nav-text">更新fstab文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修复Grub"><span class="nav-number">2.5.</span> <span class="nav-text">修复Grub</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重新配置refind"><span class="nav-number">2.6.</span> <span class="nav-text">重新配置refind</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#遇到的问题"><span class="nav-number">2.7.</span> <span class="nav-text">遇到的问题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSD优化"><span class="nav-number">3.</span> <span class="nav-text">SSD优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#开启Trim功能"><span class="nav-number">3.1.</span> <span class="nav-text">开启Trim功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IO调度器选择"><span class="nav-number">3.2.</span> <span class="nav-text">IO调度器选择</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#另外"><span class="nav-number">3.3.</span> <span class="nav-text">另外</span></a></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-user-secret"></i></span> <span class="author" itemprop="copyrightHolder">rovo98. All rights reserved.</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">32.0k</span></div><div class="footer-custom">The end always is near.</div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span><span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script type="text/javascript">var gitalk=new Gitalk({clientID:"c9d1854c8941ed48db62",clientSecret:"577ebec8a9a4e414346be5a1d9ccb0741417c910",repo:"rovo98.github.io",owner:"rovo98",admin:["rovo98"],id:location.pathname,distractionFreeMode:"true"});gitalk.render("gitalk-container")</script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('5');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("z6k4uD5nvz0L4yBDrkeEhOfq-gzGzoHsz","eiWBqdCDNSKEjz1o1nvUel7W")</script><script>function showTime(e){var t=new AV.Query(e),c=[],u=$(".leancloud_visitors");u.each(function(){c.push($(this).attr("id").trim())}),t.containedIn("url",c),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var n=0;n<e.length;n++){var o=e[n],i=o.get("url"),s=o.get("time"),r=document.getElementById(i);$(r).find(t).text(s)}for(n=0;n<c.length;n++){i=c[n],r=document.getElementById(i);var l=$(r).find(t);""==l.text()&&l.text(0)}}else u.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(i){var e=$(".leancloud_visitors"),s=e.attr("id").trim(),r=e.attr("data-flag-title").trim(),t=new AV.Query(i);t.equalTo("url",s),t.find({success:function(e){if(0<e.length){var t=e[0];t.fetchWhenSave(!0),t.increment("time"),t.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var n=new i,o=new AV.ACL;o.setPublicReadAccess(!0),o.setPublicWriteAccess(!0),n.setACL(o),n.set("title",r),n.set("url",s),n.set("time",1),n.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script><link rel="stylesheet" href="/aplayer/APlayer.min.css"><div id="aplayer"></div><script type="text/javascript" src="/aplayer/APlayer.min.js"></script><script type="text/javascript" src="/aplayer/music.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",model:{jsonPath:"/live2dw/assets/koharu.model.json"},display:{position:"right",width:80,height:180},mobile:{show:!1}})</script></body></html>